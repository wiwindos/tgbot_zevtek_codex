### Итерация 7 — **Admin Command Suite Enhancement**

*(T – F – I – P план; синхронизирован с текущим кодом `tgbot_zevtek_codex` после Iter 6)*

---

#### Текущее состояние репозитория

| Факт                                                                                                                                            | Расположение          |
| ----------------------------------------------------------------------------------------------------------------------------------------------- | --------------------- |
| Админ-чат определяется помещённым в `.env` `ADMIN_CHAT_ID`; одобрение заявки уже работает через `/admin approve <tg_id>` **или** inline-кнопку. | `bot/admin_router.py` |
| Таблица `users` содержит `is_active` и `requested_at`.                                                                                          | `database.py`         |
| Модели LLM синкаются кроном, уведомление админу шлётся.                                                                                         | `scheduler/jobs.py`   |
| База на `aiosqlite`; есть функции `log_request`, `log_response`, `log_file`.                                                                    | `database.py`         |
| Нет команд для: статистики, списка заявок, ручного обновления моделей, временного отключения пользователя.                                      | —                     |
| В `tests/` отсутствуют проверки админ-функций.                                                                                                  | `tests/…`             |

---

## 1. **T — Test first**

| Шаг                                        | Детали                                                                                                                                                                                                |
| ------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Файл**                                   | `tests/bot/test_admin_cmds.py`                                                                                                                                                                        |
| **Fixtures**                               | • tmp-DB (`init_db()`); <br>• `ADMIN_CHAT_ID = 999`; <br>• Моки `Bot.send_message` / `Message.answer`.                                                                                                |
| **Тест-кейс 1 «/admin stats»**             | Создать в БД: 3 пользователя (`is_active`: 2×1, 1×0); 10 запросов; 10 ответов; 1 файл. <br>Отправить `/admin stats` от id 999 → бот отвечает строкой «Users: 3 (2 active) • Requests: 10 • Files: 1». |
| **Тест-кейс 2 «/admin users pending»**     | БД: 2 заявки (`is_active==0`). Команда от 999 → бот шлёт список вида: «123 — Test User\n456 — Alice».                                                                                                 |
| **Тест-кейс 3 «/admin disable \<tg\_id>»** | Для активного пользователя 123: <br>• `/admin disable 123` → `users.is_active` становится 0; <br>• пользователю отправляется «Доступ временно закрыт».                                                |
| **Тест-кейс 4 «/admin models»**            | В `models` 3 строки. Команда возвращает форматированный список с датой `updated_at`.                                                                                                                  |
| **Тест-кейс 5 «/admin refresh models»**    | Мок `scheduler.pull_and_sync_models` → diff. После команды бот отвечает «Модели обновлены ☑️».                                                                                                        |
| Ожидание                                   | Все тесты падают (фич не существует).                                                                                                                                                                 |

---

## 2. **F — Feature**

| №   | Задача                                                             | Файл / модуль                                                                                                    |                                              |
| --- | ------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------- | -------------------------------------------- |
| 2.1 | **Расширить `admin_router`** (или создать `bot/admin/commands.py`) | Добавить 5 новых команд: `stats`, `users pending`, `models`, `refresh models`, `disable/enable <tg_id>`.         |                                              |
| 2.2 | **`/admin stats`**                                                 | Считаем: `SELECT COUNT(*)`, `SUM(is_active)`, `COUNT(requests)`, `COUNT(files)`; формируем краткую строку.       |                                              |
| 2.3 | **`/admin users pending`**                                         | `SELECT tg_id, name FROM users WHERE is_active=0`; группируем в список (chunk ≤4096).                            |                                              |
| 2.4 | **`/admin disable/enable`**                                        | \`set\_active(tg\_id, False                                                                                      | True)\`; уведомление пользователю о статусе. |
| 2.5 | **`/admin models`**                                                | `SELECT name, provider, updated_at FROM models ORDER BY provider,name`; вывод в таблицу Markdown или plain-list. |                                              |
| 2.6 | **`/admin refresh models`**                                        | Импорт `scheduler.jobs.pull_and_sync_models`; запускаем и показываем diff-результат.                             |                                              |
| 2.7 | **Хелп-сообщение**                                                 | Расширить `/admin help` (или `/help`) кратким описанием новых сабкоманд.                                         |                                              |
| 2.8 | **Доступ**                                                         | Все команды защищены фильтром `F.from_user.id == ADMIN_CHAT_ID`.                                                 |                                              |
| 2.9 | **Utils**                                                          | При длинных списках применять `send_long_message`.                                                               |                                              |

---

## 3. **I — Integrate**

| Действие         | Детали                                                     |
| ---------------- | ---------------------------------------------------------- |
| **README**       | Новый раздел “Админ-команды” с примерами использования.    |
| **pre-commit**   | mypy-strict для `bot/admin/*`.                             |
| **CI**           | Тесты уже подхватываются; зависимости не меняются.         |
| **.env.example** | Обновить блок `# Admin`; добавить примеры `ADMIN_CHAT_ID`. |

---

## 4. **P — Push**

```bash
git add .
git commit -m "feat(admin): stats, user list, model listing, refresh and enable/disable commands"
git push origin master
```

---

### Итог Iter 7

| Команда / Функция               | Статус                               |
| ------------------------------- | ------------------------------------ |
| `/admin stats`                  | показывает агрегаты                  |
| `/admin users pending`          | выводит список заявок                |
| `/admin models`                 | перечисляет текущие модели           |
| `/admin refresh models`         | ручной запуск синка                  |
| `/admin disable` / `enable`     | временно закрывает/возвращает доступ |
| Тест-набор `test_admin_cmds.py` | зелёный                              |
| README, .env                    | обновлены                            |
| CI / pre-commit                 | зелёные                              |
