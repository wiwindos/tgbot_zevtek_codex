### –ò—Ç–µ—Ä–∞—Ü–∏—è 12 ‚Äî **Provider Picker & Inline Model Selector**

> **–ò—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ Iter 11**
>
> * –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã `GeminiProvider`, `MistralProvider`, `DeepseekProvider` —É–∂–µ –∏–º–ø–ª–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ `ProviderRegistry`.
> * –ë–æ—Ç —Ö—Ä–∞–Ω–∏—Ç —Ç–µ–∫—É—â—É—é **–º–æ–¥–µ–ª—å** –≤ –ø–∞–º—è—Ç–∏ (`ContextBuffer.model`) –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –µ—ë —Ç–µ–∫—Å—Ç–æ–≤–æ–π –∫–æ–º–∞–Ω–¥–æ–π `/model <name>`.
> * –ü—Ä–æ–≤–∞–π–¥–µ—Ä –ø—Ä–∏ —Å–º–µ–Ω–µ –º–æ–¥–µ–ª–∏ –∏–Ω–æ–≥–¥–∞ ¬´–ø–µ—Ä–µ—Ç—è–≥–∏–≤–∞–µ—Ç¬ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –¥—Ä—É–≥–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (–æ—à–∏–±–∫–∞ UX).
> * –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å **—Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π** –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.
> * –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –ø–æ–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `.env` `DEFAULT_MODEL` –∏–ª–∏ /admin-refresh.

**–¶–µ–ª—å –∏—Ç–µ—Ä–∞—Ü–∏–∏ ‚Äî –≤–Ω–µ–¥—Ä–∏—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π UI –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (–∫–æ–º–∞–Ω–¥–∞ `/providers`) –∏ –º–æ–¥–µ–ª–µ–π (–∫–æ–º–∞–Ω–¥–∞ `/models`) —á–µ—Ä–µ–∑ inline-–∫–Ω–æ–ø–∫–∏, –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –ø—Ä–∏–≤—è–∑–∫—É ¬´–ø—Ä–æ–≤–∞–π–¥–µ—Ä ‚Üî –º–æ–¥–µ–ª—å¬ª –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.**

---

#### 1. **T ‚Äî Test first**

1. **–ù–æ–≤—ã–π —Ñ–∞–π–ª** `tests/bot/test_provider_switch.py`.
2. **–§–∏–∫—Å—Ç—É—Ä—ã**:

   * `user_id = 101`, `admin_id = 999`.
   * `available_models`: –∑–∞–≥–ª—É—à–∫–∞ —Ä–µ–µ—Å—Ç—Ä–∞:

     ```python
     {"deepseek": ["deepseek-base", "deepseek-large"],
      "mistral": ["mistral-small", "mistral-medium"],
      "gemini":  ["gemini-pro", "gemini-1.5-pro"]}
     ```
3. **–°—Ü–µ–Ω–∞—Ä–∏–π A ¬´–í—ã–±–æ—Ä –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞¬ª**

   1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —à–ª—ë—Ç `/providers` ‚Üí –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç inline-–∫–Ω–æ–ø–∫–∏ Deepseek / Mistral / Gemini.
   2. –ù–∞–∂–∏–º–∞–µ–º ¬´Mistral¬ª; –ø—Ä–æ–≤–µ—Ä—è–µ–º callback-answer ¬´–ü—Ä–æ–≤–∞–π–¥–µ—Ä –ø–µ—Ä–µ–∫–ª—é—á—ë–Ω –Ω–∞ *Mistral*¬ª.
   3. `context.user_provider[user_id] == "mistral"`.
4. **–°—Ü–µ–Ω–∞—Ä–∏–π B ¬´–°–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞¬ª**

   1. –ü–æ—Å–ª–µ A —à–ª—ë–º `/models`; –±–æ—Ç –≤—ã–≤–æ–¥–∏—Ç **—Ç–æ–ª—å–∫–æ** `["mistral-small", "mistral-medium"]`.
   2. –ù–∞–∂–∏–º–∞–µ–º ¬´mistral-medium¬ª; –ø—Ä–æ–≤–µ—Ä—è–µ–º:

      * `context.user_model[user_id] == "mistral-medium"`
      * –ü—Ä–æ–≤–∞–π–¥–µ—Ä –æ—Å—Ç–∞—ë—Ç—Å—è `"mistral"`.
5. **–°—Ü–µ–Ω–∞—Ä–∏–π C ¬´–í–æ–∑–≤—Ä–∞—Ç –∫ –ø—Ä–µ–∂–Ω–µ–º—É –ø—Ä–æ–≤–∞–π–¥–µ—Ä—É¬ª**

   1. –°–Ω–æ–≤–∞ `/providers` ‚Üí –≤—ã–±–∏—Ä–∞–µ–º ¬´Gemini¬ª, `/models` –≤—ã–≤–æ–¥–∏—Ç —Å–ø–∏—Å–æ–∫ Gemini.
   2. –ó–∞—Ç–µ–º —Å–Ω–æ–≤–∞ `/providers` ‚Üí ¬´Mistral¬ª. –û–∂–∏–¥–∞–µ–º, —á—Ç–æ –º–æ–¥–µ–ª—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∞—Å—å `mistral-medium`.
6. **–°—Ü–µ–Ω–∞—Ä–∏–π D ¬´–°–º–µ–Ω–∞ –º–æ–¥–µ–ª–∏ –Ω–µ –º–µ–Ω—è–µ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞¬ª**

   1. –ü—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä–µ Gemini –∂–º—ë–º `/models` ‚Üí –≤—ã–±–∏—Ä–∞–µ–º `gemini-pro`;
   2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ `context.user_provider` –≤—Å—ë –µ—â—ë `"gemini"`.
7. –í—Å–µ —Ç–µ—Å—Ç—ã **–∫—Ä–∞—Å–Ω—ã–µ** –¥–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.

---

#### 2. **F ‚Äî Feature**

1. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–±–æ—Ä–∞**

   * –í `services/context.py` –¥–æ–±–∞–≤–∏—Ç—å:

     ```python
     user_provider: dict[int, str]           # —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä
     user_models: dict[int, dict[str, str]]  # {prov: last_model}
     ```
   * –•–µ–ª–ø–µ—Ä—ã: `get_provider(user_id)`, `set_provider(user_id, prov)`, `get_model(user_id)`, `set_model(user_id, model)`.
2. **–ö–æ–º–∞–Ω–¥–∞ `/providers`**

   * –•—ç–Ω–¥–ª–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å inline-–∫–Ω–æ–ø–∫–∞–º–∏:
     `InlineKeyboardButton("Deepseek", callback_data="provider:deepseek")`, –∏ —Ç.–¥.
   * Callback-—Ö—ç–Ω–¥–ª–µ—Ä `provider_cb_<prov>`:

     1. `set_provider(uid, prov)`.
     2. –ï—Å–ª–∏ –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ —É–∂–µ –±—ã–ª–∞ –º–æ–¥–µ–ª—å ‚Üí –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º, –∏–Ω–∞—á–µ –±–µ—Ä—ë–º –¥–µ—Ñ–æ–ª—Ç (–ø–µ—Ä–≤—É—é –∏–∑ `list_models`).
     3. –û—Ç–≤–µ—Ç-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (`answer_callback_query`) –∏ `edit_message_text` ¬´–ü—Ä–æ–≤–∞–π–¥–µ—Ä –ø–µ—Ä–µ–∫–ª—é—á—ë–Ω‚Ä¶¬ª.
3. **–ö–æ–º–∞–Ω–¥–∞ `/models`**

   * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä; –µ—Å–ª–∏ `None` ‚Üí –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å–Ω–∞—á–∞–ª–∞ `/providers`.
   * –ó–∞–ø—Ä–æ—Å `ProviderRegistry.list_models(prov)` ‚Üí –≤—ã–¥–∞—ë—Ç —Å–ø–∏—Å–æ–∫; –≤—ã–≤–æ–¥–∏–º 1‚Äì5 –∫–Ω–æ–ø–æ–∫ –≤ —Ä—è–¥.
   * Callback `model_cb:<name>`:

     1. `set_model(uid, name)` (–∏ –∑–∞–æ–¥–Ω–æ `set_provider` –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É, –Ω–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä —É–∂–µ –≤—ã–±—Ä–∞–Ω).
     2. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ¬´–ú–æ–¥–µ–ª—å *<name>* –∞–∫—Ç–∏–≤–Ω–∞¬ª.
     3. –ù–∏–∫–∞–∫–∏—Ö —Å–∫—Ä—ã—Ç—ã—Ö side-effects (–∫–æ–Ω—Ç–æ–≤ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º).
4. **–ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤**

   * –í –∫–∞–∂–¥–æ–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä–µ: —Å–≤–æ–π—Å—Ç–≤–æ `self.model`; –º–µ—Ç–æ–¥ `set_model(name)`.
   * `ProviderRegistry.get()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É–∂–µ —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–Ω—Å—Ç–∞–Ω—Å —Å –Ω—É–∂–Ω–æ–π –º–æ–¥–µ–ª—å—é.
   * –î–ª—è Deepseek, –µ—Å–ª–∏ API –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `model`, –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å, –Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤—ã–±–æ—Ä (–¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏).
5. **–ì–∞—Ä–∞–Ω—Ç–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞**

   * –ö–æ–Ω—Ç–µ–∫—Å—Ç (`buffer.messages`) **–Ω–µ** –æ—á–∏—â–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–º–µ–Ω–µ –º–æ–¥–µ–ª–∏/–ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.
   * –î–æ–ø. –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ `generate_reply`: –µ—Å–ª–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä —Å–º–µ–Ω–∏–ª—Å—è, –Ω–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –µ—Å—Ç—å, –≤—Å—ë —Ä–∞–≤–Ω–æ –ø–µ—Ä–µ–¥–∞—ë–º –µ–≥–æ –Ω–æ–≤–æ–º—É –ø—Ä–æ–≤–∞–π–¥–µ—Ä—É.
6. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**

   * –ï—Å–ª–∏ `list_models()` ‚Üí `[]` –∏–ª–∏ API-–æ—à–∏–±–∫–∞, –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç ¬´–ú–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ¬ª.
   * Callback-—Ö—ç–Ω–¥–ª–µ—Ä –ª–æ–≤–∏—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏—è, —à–ª—ë—Ç `answer_callback_query` c `show_alert=True`.
7. **–¢–µ—Å—Ç—ã** –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ä–∞–∑–¥–µ–ª–∞ —Ç–µ–ø–µ—Ä—å –ø—Ä–æ—Ö–æ–¥—è—Ç.

---

#### 3. **I ‚Äî Integrate**

1. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**

   * README:

     * –ù–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª ¬´üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –∏ –º–æ–¥–µ–ª–∏¬ª.
     * GIF-—Å–∫—Ä–∏–Ω (—Å–¥–µ–ª–∞–µ–º –≤ Iter 18) ‚Äî –ø–æ–∫–∞ TODO.
   * CONTEXT.md ‚Äî –¥–∏–∞–≥—Ä–∞–º–º–∞ ¬´User ‚Üí Provider ‚Üî Model¬ª.
   * HELP / /start —Ç–µ–∫—Å—Ç—ã: –¥–æ–±–∞–≤–∏—Ç—å `/providers`, `/models`.
2. **pre-commit**

   * –û–±–Ω–æ–≤–∏—Ç—å `mypy.ini`, –¥–æ–±–∞–≤–∏—Ç—å `services/context.py` –≤ strict-mypy-path.
3. **CI**

   * –®–∞–≥ `aiogram-testing` (Docker service) –æ—Å—Ç–∞–≤–ª—è–µ–º; –Ω–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞—é—Ç—Å—è.
   * –î–æ–±–∞–≤–∏—Ç—å job `grep legacy refs` (–∏–∑ Iter 11) –Ω–∞ `"provider:"` –ø—Ä–µ—Ñ–∏–∫—Å—ã –≤ callback ‚Äî –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –Ω–æ –ø–æ–ª–µ–∑–Ω–æ.
4. **–ú–∏–≥—Ä–∞—Ü–∏–π –ë–î –Ω–µ—Ç** ‚Äî –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è in-memory.

---

#### 4. **P ‚Äî Push**

```bash
git add .
git commit -m "feat(ui): inline provider & model picker with per-user persistence"
git push origin main
```

---

#### –†–µ–∑—É–ª—å—Ç–∞—Ç –∏—Ç–µ—Ä–∞—Ü–∏–∏

| –ê—Ä—Ç–µ—Ñ–∞–∫—Ç / –§—É–Ω–∫—Ü–∏—è                   | –°—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ Iter 12                                      |
| ------------------------------------ | --------------------------------------------------------- |
| `/providers`                         | –≤—ã–≤–æ–¥–∏—Ç –∫–Ω–æ–ø–∫–∏, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä             |
| `/models`                            | –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ–¥–µ–ª–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –º–æ–¥–µ–ª—å |
| `ContextStorage.user_provider`       | —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ                                               |
| `ContextStorage.user_models`         | –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é –º–æ–¥–µ–ª—å –Ω–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä                  |
| –°–º–µ–Ω–∞ –º–æ–¥–µ–ª–∏ ‚â† —Å–º–µ–Ω–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞      | –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ                                             |
| UX-–æ—à–∏–±–∫–∞ ¬´–º–æ–¥–µ–ª—å –º–µ–Ω—è–µ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞¬ª | —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞                                                 |
| –¢–µ—Å—Ç-suite `test_provider_switch.py` | –∑–µ–ª—ë–Ω—ã–π                                                   |
| –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è                         | —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ (README, HELP)                           |
| CI                                   | lint + tests + docker-dry-run ‚Äî –∑–µ–ª—ë–Ω—ã–µ                   |
