### –ò—Ç–µ—Ä–∞—Ü–∏—è 14 ‚Äî **Graceful Error Handling & Model Fallback**

> **–ò—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ Iter 13**
>
> * –ó–∞–ø—Ä–æ—Å—ã –∫ LLM-API –º–æ–≥—É—Ç –∑–∞–≤–µ—Ä—à–∞—Ç—å—Å—è —Ç–∞–π–º-–∞—É—Ç–∞–º–∏ –∏–ª–∏ 4xx/5xx. –°–µ–π—á–∞—Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ª–æ–≤–∏—Ç `ErrorMiddleware`, –Ω–æ:
>   ‚Äì –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–Ω—è—Ç–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è;
>   ‚Äì –Ω–µ—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏ ¬´–≤—ã–±–µ—Ä–∏ –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å¬ª;
>   ‚Äì –æ—à–∏–±–∫–∏ –Ω–µ –∞–≥—Ä–µ–≥–∏—Ä—É—é—Ç—Å—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏.
> * –õ–æ–≥–∏ –ø–∏—à—É—Ç—Å—è —á–µ—Ä–µ–∑ `structlog`, —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω.

**–¶–µ–ª—å –∏—Ç–µ—Ä–∞—Ü–∏–∏ ‚Äî –º—è–≥–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–±–æ–µ–≤ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞:**

1. –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –í–°–ï –æ—à–∏–±–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.
2. –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ + inline-–∫–Ω–æ–ø–∫—É ¬´üìã –ú–æ–¥–µ–ª–∏¬ª.
3. –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –∏ –¥–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É on-demand –∫–æ–º–∞–Ω–¥—É `/admin errors`--—Å–≤–æ–¥–∫–∞ —Ç–æ–ø-–æ—à–∏–±–æ–∫ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á.

---

#### 1. **T ‚Äî Test first**

`tests/integration/test_fallback.py`

| –°—Ü–µ–Ω–∞—Ä–∏–π                | –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ                                                                                                                                                                                                                                                                                                                                                                                                               |
| ----------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **A: —Å–±–æ–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞**  | 1) –ú–æ–∫–∞–µ–º `GeminiProvider.generate` ‚Üí `httpx.TimeoutException`. 2) –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç ¬´–ü—Ä–∏–≤–µ—Ç¬ª. 3) –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç:<br>`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏ gemini-pro. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å.`<br>+ inline-–∫–Ω–æ–ø–∫–∞ ¬´üìã –ú–æ–¥–µ–ª–∏¬ª. 4) –í `caplog` –µ—Å—Ç—å –∑–∞–ø–∏—Å—å `provider_error` c –ø–æ–ª—è–º–∏ `provider="gemini"`, `model="gemini-pro"`, `error="TimeoutException"`. 5) –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç **—Ç–æ–ª—å–∫–æ** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. |
| **B: —Å–º–µ–Ω–∞ –º–æ–¥–µ–ª–∏**     | –ù–∞–∂–∏–º–∞–µ–º ¬´üìã –ú–æ–¥–µ–ª–∏¬ª, –≤—ã–±–∏—Ä–∞–µ–º `deepseek-base` (–º–æ–∫-–æ—Ç–≤–µ—Ç ¬´ok¬ª) ‚Üí –±–æ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç.                                                                                                                                                                                                                                                                                                                                           |
| **C: –∞–¥–º–∏–Ω—Å–∫–∞—è —Å–≤–æ–¥–∫–∞** | –ú–æ–∫–∞–µ–º 3 —Ä–∞–∑–Ω—ã—Ö –æ—à–∏–±–∫–∏, –∑–∞—Ç–µ–º –∞–¥–º–∏–Ω –ø–∏—à–µ—Ç `/admin errors`.<br> –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–∞–±–ª–∏—Ü—É –≤–∏–¥–∞:<br>`Gemini‚ÄÇgemini-pro‚ÄÇTimeoutException‚ÄÇ√ó2`<br>`Mistral‚ÄÇmistral-small‚ÄÇHTTPStatusError‚ÄÇ√ó1`                                                                                                                                                                                                                                              |

–í—Å–µ —Ç–µ—Å—Ç—ã –∫—Ä–∞—Å–Ω—ã–µ –¥–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.

---

#### 2. **F ‚Äî Feature**

1. **`safe_generate()` + `ProviderError`**

   ```python
   class ProviderError(Exception):
       def __init__(self, provider, model, exc, elapsed):
           self.provider, self.model = provider, model
           self.orig_exc, self.elapsed = exc, elapsed
   async def safe_generate(provider, prompt, files=None):
       start = perf_counter()
       try:
           return await provider.generate(prompt, files=files)
       except Exception as exc:
           raise ProviderError(provider.name, provider.model, exc, perf_counter()-start)
   ```
2. **–•—ç–Ω–¥–ª–µ—Ä –æ—à–∏–±–æ–∫** (`conversation.py`)

   * –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤—ã–∑–æ–≤ `safe_generate`.
   * –ü—Ä–∏ `ProviderError` ‚Üí

     * –ª–æ–≥ (`logger.warning("provider_error", ‚Ä¶)`),
     * –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (`send_long_message(..., log=False)`) —Å –∫–Ω–æ–ø–∫–æ–π

       ```python
       kb = InlineKeyboardMarkup(inline_keyboard=[[
           InlineKeyboardButton(text="üìã –ú–æ–¥–µ–ª–∏", callback_data="show_models")
       ]])
       ```
   * –ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –ø–æ–ø–æ–ª–Ω—è–µ–º –æ—Ç–≤–µ—Ç–æ–º-–æ—à–∏–±–∫–æ–π.
3. **Callback `show_models`**

   * –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ª–æ–≥–∏–∫—É `/models`.
   * –û—Ç–≤–µ—Ç ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Ä–µ–ø–ª–∞–π –∏–ª–∏ —à–ª—ë—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å–ø–∏—Å–∫–æ–º –º–æ–¥–µ–ª–µ–π.
4. **–•—Ä–∞–Ω–∏–ª–∏—â–µ –æ—à–∏–±–æ–∫**

   * –¢–∞–±–ª–∏—Ü–∞ `errors(id, provider, model, error, created_at)` (SQLite).
   * –ü—Ä–∏ `provider_error` ‚Üí `INSERT`.
   * –í—Å—Ç–∞–≤–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å `error_service.py`.
5. **–ê–¥–º–∏–Ω-–∫–æ–º–∞–Ω–¥–∞ `/admin errors`**

   * SQL-–∑–∞–ø—Ä–æ—Å: —Å–≤–æ–¥–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á.

     ```sql
     SELECT provider, model, error, COUNT(*) n
     FROM errors
     WHERE created_at >= DATETIME('now','-1 day')
     GROUP BY provider, model, error
     ORDER BY n DESC;
     ```
   * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º Markdown-—Ç–∞–±–ª–∏—Ü—É; –µ—Å–ª–∏ –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç ‚Äî ¬´–û—à–∏–±–æ–∫ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á –Ω–µ—Ç¬ª.
   * –†–æ—É—Ç–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ `ADMIN_CHAT_ID`.
6. **–°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π –ª–æ–≥**

   * –ü–æ–ª—è: `provider, model, error, elapsed_ms, user_id, msg="provider_error"`.
   * –£—Ä–æ–≤–µ–Ω—å `warning`, –≤—ã–≤–æ–¥ –≤ stdout (–ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç Docker-–ª–æ–≥).

---

#### 3. **I ‚Äî Integrate**

| –ó–∞–¥–∞—á–∞           | –î–µ–π—Å—Ç–≤–∏—è                                                                                                                                                    |
| ---------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** | *README* ‚Äî —Ä–∞–∑–¥–µ–ª ¬´üöë –û—à–∏–±–∫–∏ –∏ fallback¬ª: –ø—Ä–∏–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è + –æ–ø–∏—Å–∞–Ω–∏–µ `/admin errors`.<br>*docs/admin\_commands.md* ‚Äî –¥–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª ¬´–û—à–∏–±–∫–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤¬ª. |
| **CHANGELOG**    | **Added** ‚Äî graceful error UI; `/admin errors` summary.<br>**Changed** ‚Äî –≤—Å–µ –≤—ã–∑–æ–≤—ã LLM —á–µ—Ä–µ–∑ `safe_generate`.                                              |
| **–ë–î –º–∏–≥—Ä–∞—Ü–∏—è**  | `scripts/migrate.py` ‚Äî `CREATE TABLE IF NOT EXISTS errors ‚Ä¶`.                                                                                               |
| **CI**           | –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `pytest --log-cli-level=INFO`; –Ω–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –≤—Ö–æ–¥—è—Ç –≤ –æ–±—â–∏–π suite.                                                                                 |
| **Lint / mypy**  | –î–æ–±–∞–≤–∏—Ç—å `services/error_service.py` –≤ `mypy.ini strict`.                                                                                                   |

---

#### 4. **P ‚Äî Push**

```bash
git add .
git commit -m "feat(ux): graceful provider errors with inline model picker & /admin errors summary"
git push origin main
```

---

#### –†–µ–∑—É–ª—å—Ç–∞—Ç –∏—Ç–µ—Ä–∞—Ü–∏–∏

| –ê—Ä—Ç–µ—Ñ–∞–∫—Ç / –§—É–Ω–∫—Ü–∏—è                     | –°—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ Iter 14                 |
| -------------------------------------- | ------------------------------------ |
| `safe_generate()`                      | –µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—ã–∑–æ–≤–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤      |
| –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ | –≤—ã–≤–æ–¥–∏—Ç—Å—è + –∫–Ω–æ–ø–∫–∞ ¬´üìã –ú–æ–¥–µ–ª–∏¬ª       |
| –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏                  | —Ö—Ä–∞–Ω–∏—Ç —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| –¢–∞–±–ª–∏—Ü–∞ `errors`                       | —Å–æ–±–∏—Ä–∞–µ—Ç –æ—à–∏–±–∫–∏ –∑–∞ 24 —á              |
| –ö–æ–º–∞–Ω–¥–∞ `/admin errors`                | –≤—ã–≤–æ–¥–∏—Ç –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–≤–æ–¥–∫—É        |
| –¢–µ—Å—Ç-–Ω–∞–±–æ—Ä `test_fallback.py`          | –∑–µ–ª—ë–Ω—ã–π                              |
| –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è / CHANGELOG               | –æ–±–Ω–æ–≤–ª–µ–Ω—ã                            |
| CI (lint + tests + docker-dry-run)     | –∑–µ–ª—ë–Ω—ã–µ                              |
