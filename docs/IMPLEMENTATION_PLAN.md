### Итерация 15 — **Context-Limit Notifier (> 1000 символов)**

> **Исходное состояние после Iter 14**
>
> * Бот хранит историю диалога (до 20 сообщений) в `ContextStorage`, но пользователь не знает, что она растёт.
> * При длинном контексте возможны:
>   – рост стоимости запросов;
>   – ошибки «context\_length\_exceeded» у LLM-API;
>   – ухудшение качества ответов.
> * Команда `/new` (alias `/clear`) вручную очищает историю, но — без напоминаний.

**Цель итерации — автоматически предупреждать пользователя, если суммарный объём контекста превышает 1000 символов, и не спамить этим сообщением до тех пор, пока контекст не будет очищен.**

---

#### 1. **T — Test first**

`tests/bot/test_context_limit.py`

| Сценарий                   | Ожидаемое поведение                                                                                                                                                                                                                                                                               |
| -------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **A: превышение лимита**   | 1) От имени `user_id=303` подряд отправляем 11 сообщений по 120 симв. каждый (≈1320 симв.).<br>2) После 10-го сообщения бот **не** предупреждает.<br>3) После 11-го бот отвечает отдельным сообщением:<br>`ℹ️ У вас большой контекст (1320 симв.). Рекомендуется очистить историю командой /new.` |
| **B: повторное сообщение** | 1) Отправляем ещё 3 сообщения (контекст ещё больше).<br>2) Бот **не** дублирует предупреждение.                                                                                                                                                                                                   |
| **C: сброс после /new**    | 1) Шлём `/new` → «Контекст очищен ✅».<br>2) Отправляем 9 сообщений по 120 симв. (≈1080).<br>3) Бот снова присылает **одно** предупреждение после первого превышения.                                                                                                                              |

Тесты красные до реализации.

---

#### 2. **F — Feature**

1. **Расширение `ContextStorage`**

   ```python
   class ContextStorage:
       ...
       warned: dict[int, bool] = {}  # user_id → bool
       def total_chars(self, user_id: int) -> int:
           return sum(len(m["content"]) for m in self.messages.get(user_id, []))
   ```
2. **Порог и настройки**

   * Константа `CONTEXT_WARN_THRESHOLD = int(os.getenv("CONTEXT_WARN_THRESHOLD", 1000))`.
   * Возможность изменить порог через `.env`.
3. **Логика проверки**

   * В хэндлере приёма пользовательского текста (`conversation.py` → `on_user_message`) ПОСЛЕ добавления сообщения в буфер:

     ```python
     total = buffer.total_chars(uid)
     if total > CONTEXT_WARN_THRESHOLD and not buffer.warned.get(uid, False):
         await send_long_message(
             msg.chat.id,
             f"ℹ️ У вас большой контекст ({total} симв.). "
             "Рекомендуется очистить историю командой /new.",
             log=False,
         )
         buffer.warned[uid] = True
     ```
4. **Сброс флага**

   * В `/new` (и `/clear`) после `buffer.clear(uid)` → `buffer.warned[uid] = False`.
5. **Без спама**

   * Предупреждение срабатывает **один раз** до очистки контекста.
6. **Логирование**

   * `logger.info("context_warn", user_id=uid, total_chars=total)` для аналитики.

---

#### 3. **I — Integrate**

| Задача              | Действие                                                                                                                                                                                   |
| ------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Документация**    | *README* → подраздел «Контекст и лимиты»: объяснить порог 1000 симв. и команду `/new`.<br>*HELP*-текст дополнить строкой «Бот напомнит очистить контекст, если он станет слишком большим». |
| **CHANGELOG**       | **Added** — автоматическое предупреждение при >1000 символах контекста.                                                                                                                    |
| **CI / pre-commit** | Тесты автоматически подхватываются; добавить `CONTEXT_WARN_THRESHOLD=900` в `pytest.ini` при desire (используем default).                                                                  |
| **Config examples** | `.env.example` → добавить закомментированную строку `# CONTEXT_WARN_THRESHOLD=1000`.                                                                                                       |

---

#### 4. **P — Push**

```bash
git add .
git commit -m "feat(ctx): auto-warning when conversation exceeds 1000 chars"
git push origin main
```

---

#### Результат итерации

| Артефакт / Функция                     | Статус после Iter 15                         |
| -------------------------------------- | -------------------------------------------- |
| Пороговое предупреждение (>1000 симв.) | выводится 1 раз до очистки                   |
| Флаг `buffer.warned`                   | предотвращает спам                           |
| Команда `/new`                         | сбрасывает историю **и** флаг предупреждения |
| Тест-кейс `test_context_limit.py`      | зелёный                                      |
| Переменная `CONTEXT_WARN_THRESHOLD`    | настраивается через `.env`                   |
| Документация / CHANGELOG               | обновлены                                    |
| CI (lint + tests + docker-dry-run)     | зелёные                                      |
