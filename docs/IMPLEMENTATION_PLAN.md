Ниже — твой обновлённый план Итерации 9, только текстовые инструкции (без вставок кода), с доработками для стабильного прохождения тестов и корректной CI:

---

### Итерация 9 — Docker, Compose & One-Click Deploy

*T – F – I – P-план; сверяется с текущим состоянием репозитория после Iter 8*

---

#### Текущее состояние репозитория

* Есть базовый Dockerfile (python:3.11-slim, копирует проект, запускает `bot.main`).
* Нет файла `.dockerignore`.
* Нет каталога `deploy` с docker-compose.
* CI собирает образ, но не тестирует запуск контейнера и не пушит его.
* Отсутствуют Make-файл и кнопка «Deploy to …» в README.

---

## 1. T — Test first

1. **Пропуск при отсутствии Docker-демона**
   Добавить в начало теста-файла автопроверку `docker info` и `pytest.skip`, если демон не запущен.
2. **Тест сборки и запуска образа**

   * Собирать образ с тегом `tgbot:test`.
   * Запускать контейнер в фоне с обязательными переменными окружения (`BOT_TOKEN`, `ADMIN_CHAT_ID`, `LOG_LEVEL`).
   * Ожидать в логах появления маркера старта (например, `bot_started`).
   * Если в образе есть HEALTHCHECK — дополнительно проверять статус `healthy`.
   * Контейнер удаляется автоматически (`--rm`).
3. **Тест запуска через Docker Compose**

   * Поднимать `docker compose -f deploy/docker-compose.dev.yml up -d --build`.
   * Проверять, что сервис `bot` становится `healthy`.
   * Проверять, что на хосте появился том `./data`.
   * Останавливать и удалять всё через `docker compose down`.

---

## 2. F — Feature

1. **Dockerfile**

   * Перейти на образ `python:3.11-slim`.
   * Ввести ARG `BUILD_ENV=prod` (для разделения dev/prod установки зависимостей).
   * Создать неправавого пользователя `bot` и переключиться на него.
   * Кешировать слой с установкой зависимостей (requirements или poetry).
   * Скопировать только нужные файлы (с учётом `.dockerignore`).
   * Открыть порт 8080.
   * Добавить HEALTHCHECK, который на `/ping` возвращает успешный код.
   * Установить LABEL с версией образа из переменной среды.
2. **.dockerignore**

   * Исключить каталоги `__pycache__`, `tests`, `.venv`, файлы `*.log`, `*.db`, `.env` и прочее лишнее.
3. **docker-compose.dev.yml**

   * Описать сервис `bot`, который:

     * строится из текущей директории;
     * монтирует том `./data:/app/data`;
     * подхватывает переменные из файла `.env`;
     * перезапускается при сбое;
     * выставляет healthcheck по HTTP `/ping`.
4. **docker-compose.prod.yml**

   * Тот же сервис, но:

     * использует заранее запушенный образ из GHCR;
     * получает переменные через `environment`;
     * рестарт всегда;
     * задаёт `TZ=Europe/Berlin`.
5. **Entrypoint-script**

   * Вынести в `scripts/entrypoint.sh` последовательность инициализации БД и старта приложения;
   * Сделать скрипт исполняемым и подключить через `ENTRYPOINT`.
6. **GitHub Actions: build & test & publish**

   * Добавить job для тестирования образа и compose (с пропуском при отсутствии Docker).
   * Обеспечить в job доступ к Docker Buildx (multi-arch).
   * После успешных тестов — job для логина в GHCR и пуша образа:

     * пушить на SHA-тег агитированно;
     * при пуше тегов — дополнительно тегировать `latest`.
7. **Badges & Deploy button**

   * В README разместить бейджи CI и GHCR (pulls/size).
   * Добавить «Deploy to Railway» (или generic) кнопку с настройкой `railway.json`.
8. **Makefile**

   * Добавить цели:

     * поднять dev-compose;
     * опустить dev-compose;
     * собрать локальный образ;
     * запушить образ в GHCR.
9. **ENV изменения**

   * Везде, где нужно, прописать `TZ=Europe/Berlin`.
10. **Version label**

* В Dockerfile и метаданных образа проставить версию через переменную `$VERSION`.

---

## 3. I — Integrate

* **README**
  — Описать раздел «Docker / Compose»: команды запуска dev и prod, переменные, том `./data`.
* **pre-commit**
  — Подключить `hadolint` для линтинга Dockerfile.
* **CI**
  — Убедиться, что прописаны `docker/setup-buildx-action` (и при необходимости `docker/setup-qemu-action`).
* **Docs**
  — В `docs/deploy.md` привести пошаговый гайд: клонирование, копирование `.env`, `make compose-up`, проверка `/ping`, остановка.

---

## 4. P — Push

* Закоммитить все изменения с кратким сообщением о готовности Docker, Compose и CI.
* Сделать `git push origin master`.
