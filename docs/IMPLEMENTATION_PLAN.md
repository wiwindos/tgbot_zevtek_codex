### **–ù–æ–≤–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è 8-bis ‚Äî Proxy Gateway & Model Selector**

*(–¥–æ–±–∞–≤–ª–µ–Ω–∞ –º–µ–∂–¥—É Iter 8 –∏ Iter 9 –≤ **GENERAL\_IMPLEMENTATION\_PLAN.md**; –ø–ª–∞–Ω –≤ —Ñ–æ—Ä–º–∞—Ç–µ T ‚Äì F ‚Äì I ‚Äì P)*

---

#### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–ø–æ—Å–ª–µ Iter 8)

| –§–∞–∫—Ç                                                                                                       | –§–∞–π–ª / –∫–∞—Ç–∞–ª–æ–≥           |
| ---------------------------------------------------------------------------------------------------------- | ------------------------ |
| **GeminiProvider** –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ Vertex AI –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ `google-cloud-aiplatform`, –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø—Ä–æ–∫—Å–∏ –Ω–µ—Ç. | `providers/gemini.py`    |
| –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –µ—Å—Ç—å inline-–∫–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏, –Ω–æ —Å–º–µ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å.              | `bot/handlers/dialog.py` |
| –ö–æ–Ω—Ç–µ–∫—Å—Ç-–±—É—Ñ–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç, —Ö—Ä–∞–Ω–∏—Ç —Ü–µ–ø–æ—á–∫—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞—Ç–∞.                                                  | `services/context.py`    |
| –ê–¥–º–∏–Ω-router —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (approve, stats –∏ —Ç. –¥.).                                                      | `bot/admin_router.py`    |

---

## 1. **T ‚Äî Test first**

| ‚Ññ | –¢–µ—Å—Ç-–∫–µ–π—Å                           | –ü—Ä–æ–≤–µ—Ä–∫–∞                                                                                                                                                                   |
| - | ----------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1 | **`/admin proxy set <str>`**        | ‚Ä¢ –ò–∑ –∞–¥–º–∏–Ω-—á–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É `191.102.181.223:9653:F8AaEo:rFkG`.<br>‚Ä¢ –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç ¬´Proxy saved ‚úÖ¬ª.<br>‚Ä¢ –í –ë–î —Ç–∞–±–ª–∏—Ü–∞ `settings` —Å–æ–¥–µ—Ä–∂–∏—Ç key=`gemini_proxy`.         |
| 2 | **`/admin proxy check`**            | ‚Ä¢ –ú–æ–∫–∞–µ–º `httpx.AsyncClient.get` ‚Üí OK.<br>‚Ä¢ –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç ¬´Proxy alive üü¢ (120 ms)¬ª.                                                                                        |
| 3 | **–°–º–µ–Ω–∞ –º–æ–¥–µ–ª–∏ —é–∑–µ—Ä–æ–º**             | ‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å `/model mistral-8x7b`.<br>‚Ä¢ –ë—É—Ñ–µ—Ä `ContextBuffer.get(chat_id)` –≤—Å—ë –µ—â—ë —Ö—Ä–∞–Ω–∏—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (len > 0).<br>‚Ä¢ –°–ª–µ–¥—É—é—â–∏–π –≤–≤–æ–¥ —É—Ö–æ–¥–∏—Ç –≤ MistralProvider. |
| 4 | **Gemini –∑–∞–ø—Ä–æ—Å –∏–¥—ë—Ç —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏** | ‚Ä¢ –°—Ç–∞–≤–∏–º –ø—Ä–æ–∫—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ.<br>‚Ä¢ –ú–æ–∫–∞–µ–º `httpx.AsyncClient.post` –∏ —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç `proxies={"all://": "..."} `.                                                   |

–í—Å–µ —Ç–µ—Å—Ç—ã —Å–µ–π—á–∞—Å –ø–∞–¥–∞—é—Ç.

---

## 2. **F ‚Äî Feature**

| ‚Ññ   | –ó–∞–¥–∞—á–∞                         | –§–∞–π–ª / –º–æ–¥—É–ª—å                                                                                                                                                                                                             |
| --- | ------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 2.1 | **–¢–∞–±–ª–∏—Ü–∞ `settings`**         | –í `database.py`: `CREATE TABLE IF NOT EXISTS settings (key TEXT PK, value TEXT)`; helpers `get_setting`, `set_setting`.                                                                                                   |
| 2.2 | **Proxy-Aware GeminiProvider** | ‚Ä¢ –î–æ–ø. –ø–æ–ª–µ `_proxy_url`.<br>‚Ä¢ –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —á–∏—Ç–∞–µ—Ç `get_setting("gemini_proxy")`.<br>‚Ä¢ –ü—Ä–∏ `generate()` —Å–æ–∑–¥–∞—ë—Ç `httpx.AsyncClient(proxies={"all://": self._proxy_url})` –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ.                                     |
| 2.3 | **Admin-–∫–æ–º–∞–Ω–¥—ã**              | *–í `admin_router`*:  <br>‚Ä¢ `/admin proxy set <str>` ‚Äî –≤–∞–ª–∏–¥–∞—Ü–∏—è, –∑–∞–ø–∏—Å—å –≤ `settings`, reply OK.<br>‚Ä¢ `/admin proxy check` ‚Äî HEAD-–∑–∞–ø—Ä–æ—Å –∫ `https://generativelanguage.googleapis.com` —á–µ—Ä–µ–∑ —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–∫—Å–∏; –∏–∑–º–µ—Ä—è–µ–º RTT. |
| 2.4 | **–•—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏**  | ‚Ä¢ –í `services/context.py` –¥–æ–±–∞–≤–∏—Ç—å `selected_model` –≤–Ω—É—Ç—Ä–∏ per-chat state.<br>‚Ä¢ –ö–æ–º–∞–Ω–¥–∞ `/model <name>` (–∏–ª–∏ inline —Å–ø–∏—Å–æ–∫) –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, **–Ω–µ** –æ–±–Ω—É–ª—è—è `history`.                                          |
| 2.5 | **–ö–æ–º–∞–Ω–¥–∞ `/models`**          | –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ `ProviderRegistry.list_all()` –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.                                                                                                                                                         |
| 2.6 | **–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞**      | –í `generate_reply(chat_id, prompt)` –ø–æ–ª—É—á–∞—Ç—å `model=context.selected_model` –ª–∏–±–æ default `os.getenv("DEFAULT_MODEL")`.                                                                                                    |
| 2.7 | **ENV / defaults**             | `.env.example` ‚Äî `DEFAULT_MODEL=gemini-pro`, `GEMINI_PROXY=`.                                                                                                                                                             |

---

## 3. **I ‚Äî Integrate**

| –ó–∞–¥–∞—á–∞         | –î–µ—Ç–∞–ª–∏                                                                             |
| -------------- | ---------------------------------------------------------------------------------- |
| **README**     | –ù–æ–≤—ã–π –ø–æ–¥—Ä–∞–∑–¥–µ–ª ‚ÄúProxy for Gemini‚Äù —Å —Ñ–æ—Ä–º–∞—Ç–æ–º `host:port:user:pass`.               |
| **Docs**       | –û–±–Ω–æ–≤–∏—Ç—å `docs/admin_commands.md` –æ–ø–∏—Å–∞–Ω–∏–µ–º `/admin proxy*`.                       |
| **pre-commit** | mypy-strict –¥–ª—è `providers/gemini.py`, `bot/admin_router.py`.                      |
| **CI**         | –í —Ç–µ—Å—Ç–æ–≤–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `httpx[socks]` (–¥–ª—è –ø—Ä–æ–∫—Å–∏-URL —Ç–∏–ø–∞ `socks5://`). |

---

## 4. **P ‚Äî Push**

```bash
git add .
git commit -m "feat(proxy): per-admin Gemini proxy config + persistent model selector"
git push origin master
```

---

### **–†–µ–∑—É–ª—å—Ç–∞—Ç –∏—Ç–µ—Ä–∞—Ü–∏–∏ 8-bis**

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç / –§—É–Ω–∫—Ü–∏—è                   | –°—Ç–∞—Ç—É—Å                               |
| ------------------------------------- | ------------------------------------ |
| –¢–∞–±–ª–∏—Ü–∞ `settings`                    | —Ö—Ä–∞–Ω–∏—Ç `gemini_proxy`                |
| –ö–æ–º–∞–Ω–¥—ã `/admin proxy set / check`    | —Ä–∞–±–æ—Ç–∞—é—Ç, –ø—Ä–æ–≤–µ—Ä—è—é—Ç RTT              |
| –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å `/model`                | —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—ã–±–æ—Ä, –∏—Å—Ç–æ—Ä–∏—è –Ω–µ —Ç–µ—Ä—è–µ—Ç—Å—è |
| GeminiProvider                        | –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ–∫—Å–∏ –∏–∑ –ë–î              |
| –¢–µ—Å—Ç-–Ω–∞–±–æ—Ä `test_proxy`, `test_model` | –∑–µ–ª—ë–Ω—ã–π                              |
| README / docs                         | –æ–±–Ω–æ–≤–ª–µ–Ω—ã                            |
| CI                                    | –ø—Ä–æ—Ö–æ–¥–∏—Ç                             |
